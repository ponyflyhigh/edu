<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>ç®€æ˜“è¯­éŸ³é‡‡é›†å¹¶å‘é€ WebSocket</title>
</head>
<body>
  <h2>å½•éŸ³å¹¶é€šè¿‡WebSocketå‘é€PCMæ•°æ®</h2>
  <button id="start">å¼€å§‹å½•éŸ³</button>
  <button id="stop">åœæ­¢å½•éŸ³</button>
  <pre id="log"></pre>

<script>
  const WS_URL = "ws://localhost:8765";
  let ws;
  let audioContext;
  let processor;
  let input;
  let stream;

  const logElem = document.getElementById('log');
  function log(msg) {
    logElem.textContent += msg + '\n';
    console.log(msg);
  }

  function floatTo16BitPCM(input) {
    const output = new Int16Array(input.length);
    for (let i = 0; i < input.length; i++) {
      let s = Math.max(-1, Math.min(1, input[i]));
      output[i] = s < 0 ? s * 0x8000 : s * 0x7FFF;
    }
    return output;
  }

  document.getElementById('start').onclick = async () => {
    ws = new WebSocket(WS_URL);
    ws.binaryType = 'arraybuffer';

    ws.onopen = () => {
      log("âœ… WebSocket å·²è¿æ¥");
    };
    ws.onerror = e => log("âŒ WebSocket é”™è¯¯: " + e.message);
    ws.onclose = () => log("â„¹ï¸ WebSocket å·²å…³é—­");

    stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    audioContext = new AudioContext({ sampleRate: 16000 });
    input = audioContext.createMediaStreamSource(stream);
    processor = audioContext.createScriptProcessor(4096, 1, 1);

    input.connect(processor);
    processor.connect(audioContext.destination);

    processor.onaudioprocess = (e) => {
      const floatData = e.inputBuffer.getChannelData(0);
      const pcmData = floatTo16BitPCM(floatData);
      if (ws.readyState === WebSocket.OPEN) {
        ws.send(pcmData.buffer);
        log(`å‘é€PCMæ•°æ®: å­—èŠ‚é•¿åº¦=${pcmData.byteLength}`);
      }
    };
  };

  document.getElementById('stop').onclick = () => {
    if (processor) processor.disconnect();
    if (input) input.disconnect();
    if (stream) stream.getTracks().forEach(track => track.stop());
    if (audioContext) audioContext.close();
    if (ws) ws.close();
    log("ğŸ›‘ å½•éŸ³åœæ­¢ï¼Œè¿æ¥å…³é—­");
  };
</script>

</body>
</html>
